<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sincronizaci√≥n Multi-Dispositivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">
            üîÑ Test Sincronizaci√≥n Multi-Dispositivo
        </h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Panel de Control -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-cogs mr-2 text-blue-500"></i>
                    Panel de Control
                </h2>
                
                <!-- Estado del Servicio -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-3">Estado del Servicio</h3>
                    <div class="flex items-center justify-between mb-3">
                        <span id="service-status">üü° Cargando...</span>
                        <label class="switch">
                            <input type="checkbox" id="service-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <!-- Bot√≥n adicional como respaldo -->
                    <button id="toggle-service-btn" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                        üîÑ Cambiar Estado del Servicio
                    </button>
                </div>
                
                <!-- Productos de Prueba -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-3">Productos de Prueba</h3>
                    <div class="space-y-2">
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span>üçî Hamburguesa Cl√°sica (ID: 1)</span>
                            <button onclick="toggleProduct(1)" id="toggle-1" class="px-3 py-1 rounded text-sm bg-gray-200">
                                Cargando...
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span>üçî BBQ Beacon (ID: 2)</span>
                            <button onclick="toggleProduct(2)" id="toggle-2" class="px-3 py-1 rounded text-sm bg-gray-200">
                                Cargando...
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <span>üå≠ Hotdog Jumbo (ID: 5)</span>
                            <button onclick="toggleProduct(5)" id="toggle-5" class="px-3 py-1 rounded text-sm bg-gray-200">
                                Cargando...
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Acciones R√°pidas -->
                <div class="space-y-2">
                    <button onclick="showAllProducts()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                        <i class="fas fa-eye mr-2"></i>Mostrar Todos
                    </button>
                    <button onclick="hideAllProducts()" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600">
                        <i class="fas fa-eye-slash mr-2"></i>Ocultar Todos
                    </button>
                </div>
            </div>

            <!-- Panel de Monitoreo -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-green-500"></i>
                    Monitoreo en Tiempo Real
                </h2>
                
                <!-- Estad√≠sticas -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600" id="updates-count">0</div>
                        <div class="text-sm text-blue-800">Actualizaciones</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600" id="hidden-count">0</div>
                        <div class="text-sm text-green-800">Productos Ocultos</div>
                    </div>
                </div>
                
                <!-- Estado Actual -->
                <div class="mb-4">
                    <h3 class="font-semibold mb-2">Estado Actual:</h3>
                    <pre id="current-state" class="bg-gray-100 p-3 rounded text-xs font-mono overflow-x-auto">
Cargando...
                    </pre>
                </div>
                
                <!-- Instrucciones -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Instrucciones:
                    </h4>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        <li>‚Ä¢ Abre esta p√°gina en m√∫ltiples pesta√±as</li>
                        <li>‚Ä¢ Cambia configuraciones en una pesta√±a</li>
                        <li>‚Ä¢ Observa los cambios autom√°ticos en otras pesta√±as</li>
                        <li>‚Ä¢ Tambi√©n funciona entre diferentes dispositivos</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Log de Actividad -->
        <div class="mt-6 bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-history mr-2 text-purple-500"></i>
                Log de Actividad
            </h2>
            <div id="activity-log" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-64 overflow-y-auto">
                <div>Sistema inicializando...</div>
            </div>
            <button onclick="clearLog()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                <i class="fas fa-trash mr-2"></i>Limpiar Log
            </button>
        </div>
    </div>

    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #10b981;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>

    <script type="module">
        // Import Firebase directly here
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCf7-6oLHjpNgU1zr4qdTrOKuXGe1ht2Zs",
            authDomain: "sr-sra-burger.firebaseapp.com", 
            projectId: "sr-sra-burger",
            storageBucket: "sr-sra-burger.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Create Firebase Manager directly here
        class SimpleFirebaseManager {
            constructor() {
                this.db = db;
                this.settingsRef = 'admin-settings';
            }

            async getSettings() {
                try {
                    const docRef = doc(this.db, this.settingsRef, 'main');
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        return docSnap.data();
                    } else {
                        const defaultSettings = {
                            serviceActive: true,
                            hiddenProducts: [],
                            lastUpdated: new Date().toISOString()
                        };
                        await this.saveSettings(defaultSettings);
                        return defaultSettings;
                    }
                } catch (error) {
                    console.error('Error obteniendo configuraciones:', error);
                    throw error;
                }
            }

            async saveSettings(settings) {
                try {
                    const docRef = doc(this.db, this.settingsRef, 'main');
                    const settingsToSave = {
                        ...settings,
                        lastUpdated: new Date().toISOString()
                    };
                    await setDoc(docRef, settingsToSave);
                    console.log('Configuraciones guardadas en Firebase');
                    return true;
                } catch (error) {
                    console.error('Error guardando configuraciones:', error);
                    throw error;
                }
            }

            listenToSettings(callback) {
                try {
                    const docRef = doc(this.db, this.settingsRef, 'main');
                    return onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            console.log('Firebase listener recibi√≥ datos:', JSON.stringify(data, null, 2));
                            callback(data);
                        } else {
                            console.log('No se encontr√≥ documento en Firebase');
                        }
                    });
                } catch (error) {
                    console.error('Error en listener de configuraciones:', error);
                }
            }
        }

        // Make Firebase Manager available globally
        window.firebaseManager = new SimpleFirebaseManager();
    </script>

    <script>
        // Variables globales
        let currentSettings = {
            serviceActive: true,
            hiddenProducts: []
        };
        let updatesCount = 0;

        // Elementos DOM
        const serviceToggle = document.getElementById('service-toggle');
        const serviceStatus = document.getElementById('service-status');
        const currentStateEl = document.getElementById('current-state');
        const activityLog = document.getElementById('activity-log');
        const updatesCountEl = document.getElementById('updates-count');
        const hiddenCountEl = document.getElementById('hidden-count');

        // Funci√≥n de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            const colors = {
                info: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                success: 'text-blue-400'
            };
            logEntry.className = colors[type] || 'text-green-400';
            logEntry.textContent = `[${timestamp}] ${message}`;
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
            console.log(message);
        }

        // Actualizar UI
        function updateUI() {
            // Actualizar estado del servicio
            serviceToggle.checked = currentSettings.serviceActive;
            serviceStatus.textContent = currentSettings.serviceActive ? 
                'üü¢ Servicio Activo' : 'üî¥ Servicio Inactivo';

            // Actualizar botones de productos
            [1, 2, 5].forEach(productId => {
                const button = document.getElementById(`toggle-${productId}`);
                const isHidden = currentSettings.hiddenProducts.includes(productId);
                button.textContent = isHidden ? 'Mostrar' : 'Ocultar';
                button.className = `px-3 py-1 rounded text-sm ${isHidden ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
            });

            // Actualizar estado actual
            currentStateEl.textContent = JSON.stringify(currentSettings, null, 2);

            // Actualizar contadores
            updatesCountEl.textContent = updatesCount;
            hiddenCountEl.textContent = currentSettings.hiddenProducts.length;
        }

        // Funciones de control
        window.toggleProduct = async function(productId) {
            try {
                log(`Cambiando visibilidad del producto ${productId}...`);
                
                // Check if Firebase manager is available
                if (!window.firebaseManager) {
                    log('‚ùå Firebase Manager no disponible para productos', 'error');
                    return;
                }
                
                const hiddenProducts = [...currentSettings.hiddenProducts];
                const index = hiddenProducts.indexOf(productId);
                
                if (index > -1) {
                    hiddenProducts.splice(index, 1);
                    log(`Producto ${productId} ahora es VISIBLE`, 'success');
                } else {
                    hiddenProducts.push(productId);
                    log(`Producto ${productId} ahora est√° OCULTO`, 'warning');
                }
                
                const newSettings = {
                    ...currentSettings,
                    hiddenProducts: hiddenProducts
                };
                
                await window.firebaseManager.saveSettings(newSettings);
                log(`‚úÖ Cambio de producto ${productId} guardado en Firebase`, 'success');
            } catch (error) {
                log(`Error al cambiar producto ${productId}: ${error.message}`, 'error');
            }
        };

        window.showAllProducts = async function() {
            try {
                log('Mostrando todos los productos...', 'info');
                
                if (!window.firebaseManager) {
                    log('‚ùå Firebase Manager no disponible para mostrar productos', 'error');
                    return;
                }
                
                const newSettings = {
                    ...currentSettings,
                    hiddenProducts: []
                };
                await window.firebaseManager.saveSettings(newSettings);
                log('Todos los productos son ahora VISIBLES', 'success');
            } catch (error) {
                log(`Error al mostrar todos los productos: ${error.message}`, 'error');
            }
        };

        window.hideAllProducts = async function() {
            try {
                log('Ocultando todos los productos...', 'info');
                
                if (!window.firebaseManager) {
                    log('‚ùå Firebase Manager no disponible para ocultar productos', 'error');
                    return;
                }
                
                const newSettings = {
                    ...currentSettings,
                    hiddenProducts: [1, 2, 5, 6, 7, 8] // IDs de ejemplo
                };
                await window.firebaseManager.saveSettings(newSettings);
                log('Todos los productos est√°n ahora OCULTOS', 'warning');
            } catch (error) {
                log(`Error al ocultar todos los productos: ${error.message}`, 'error');
            }
        };

        window.clearLog = function() {
            activityLog.innerHTML = '<div>Log limpiado...</div>';
        };

        // Event listeners
        serviceToggle.addEventListener('change', async () => {
            try {
                const isActive = serviceToggle.checked;
                log(`Cambiando servicio a ${isActive ? 'ACTIVO' : 'INACTIVO'}...`);
                
                const newSettings = {
                    ...currentSettings,
                    serviceActive: isActive
                };
                
                // Check if Firebase manager is available
                if (!window.firebaseManager) {
                    log('‚ùå Firebase Manager no disponible', 'error');
                    serviceToggle.checked = currentSettings.serviceActive; // Revert
                    return;
                }
                
                await window.firebaseManager.saveSettings(newSettings);
                log(`Servicio ${isActive ? 'ACTIVADO' : 'DESACTIVADO'}`, isActive ? 'success' : 'warning');
            } catch (error) {
                log(`Error al cambiar estado del servicio: ${error.message}`, 'error');
                // Revertir toggle en caso de error
                serviceToggle.checked = currentSettings.serviceActive;
            }
        });

        // Event listener para el bot√≥n adicional de servicio
        document.getElementById('toggle-service-btn').addEventListener('click', async () => {
            try {
                const newStatus = !currentSettings.serviceActive;
                log(`Cambiando servicio a ${newStatus ? 'ACTIVO' : 'INACTIVO'} (usando bot√≥n)...`);
                
                const newSettings = {
                    ...currentSettings,
                    serviceActive: newStatus
                };
                
                // Check if Firebase manager is available
                if (!window.firebaseManager) {
                    log('‚ùå Firebase Manager no disponible', 'error');
                    return;
                }
                
                await window.firebaseManager.saveSettings(newSettings);
                log(`Servicio ${newStatus ? 'ACTIVADO' : 'DESACTIVADO'}`, newStatus ? 'success' : 'warning');
            } catch (error) {
                log(`Error al cambiar estado del servicio: ${error.message}`, 'error');
            }
        });

        // Inicializaci√≥n
        async function init() {
            log('üöÄ Inicializando test de sincronizaci√≥n...');
            
            // Esperar Firebase
            const waitForFirebase = () => {
                if (window.firebaseManager) {
                    log('‚úÖ Firebase Manager conectado');
                    setupFirebase();
                } else {
                    setTimeout(waitForFirebase, 100);
                }
            };
            waitForFirebase();
        }

        async function setupFirebase() {
            try {
                // Cargar configuraciones iniciales
                currentSettings = await window.firebaseManager.getSettings();
                log('üìã Configuraciones iniciales cargadas');
                updateUI();

                // Configurar listener en tiempo real
                window.firebaseManager.listenToSettings((newSettings) => {
                    if (newSettings) {
                        updatesCount++;
                        log(`üîî Actualizaci√≥n recibida #${updatesCount}`, 'info');
                        
                        // Detectar cambios espec√≠ficos
                        if (currentSettings.serviceActive !== newSettings.serviceActive) {
                            log(`Servicio cambi√≥: ${currentSettings.serviceActive} ‚Üí ${newSettings.serviceActive}`, 'success');
                        }
                        
                        if (JSON.stringify(currentSettings.hiddenProducts) !== JSON.stringify(newSettings.hiddenProducts)) {
                            log(`Productos ocultos cambiaron: [${currentSettings.hiddenProducts.join(',')}] ‚Üí [${newSettings.hiddenProducts.join(',')}]`, 'success');
                        }
                        
                        currentSettings = newSettings;
                        updateUI();
                    }
                });

                log('üëÇ Listener en tiempo real configurado');
                log('‚úÖ Sistema listo para sincronizaci√≥n multi-dispositivo', 'success');

            } catch (error) {
                log(`‚ùå Error configurando Firebase: ${error.message}`, 'error');
            }
        }

        // Inicializar cuando la p√°gina carga
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
